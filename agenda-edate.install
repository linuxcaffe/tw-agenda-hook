#!/usr/bin/env bash
set -euo pipefail

# ============================================================================
# agenda-edate - Installer Script
# Version: 1.0.0
# Generated by make-awesome.py
# ============================================================================

VERSION="1.0.0"
APPNAME="agenda-edate"
BASE_URL="https://raw.githubusercontent.com/linuxcaffe/tw-agenda-hook/main/"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

tw_msg() { echo -e "${BLUE}[tw]${NC} $*"; }
tw_success() { echo -e "${GREEN}[tw] ✓${NC} $*"; }
tw_error() { echo -e "${RED}[tw] ✗${NC} $*" >&2; }

# Debug support
DEBUG_LEVEL="${TW_DEBUG:-0}"
debug_msg() {
    local msg="$1"
    local level="${2:-1}"
    if [[ $DEBUG_LEVEL -ge $level ]]; then
        echo -e "${BLUE}[DEBUG-$level]${NC} $msg" >&2
    fi
}

debug_msg "Starting installer with DEBUG_LEVEL=$DEBUG_LEVEL" 1

# Directories
HOME="${HOME:-$(eval echo ~$USER)}"
TASKRC="${HOME}/.taskrc"
TASK_DIR="${HOME}/.task"
HOOKS_DIR="${TASK_DIR}/hooks"
SCRIPTS_DIR="${TASK_DIR}/scripts"
CONFIG_DIR="${TASK_DIR}/config"
DOCS_DIR="${TASK_DIR}/docs"

# ============================================================================
# Installation Function
# ============================================================================

install() {
    tw_msg "Installing agenda-edate v$VERSION..."
    debug_msg "Starting installation" 1

    # Create directories
    tw_msg "Creating directories..."
    mkdir -p "$HOOKS_DIR" "$SCRIPTS_DIR" "$CONFIG_DIR" "$DOCS_DIR"
    debug_msg "Directories created" 2

    tw_msg "Downloading files..."
    debug_msg "Using BASE_URL: $BASE_URL" 2

    debug_msg "Downloading hook: on-add_agenda.py" 2
    curl -fsSL "$BASE_URL/on-add_agenda.py" -o "$HOOKS_DIR/on-add_agenda.py" || {
        tw_error "Failed to download on-add_agenda.py"
        debug_msg "Download failed: on-add_agenda.py" 1
        return 1
    }
    chmod +x "$HOOKS_DIR/on-add_agenda.py"
    debug_msg "Installed hook: $HOOKS_DIR/on-add_agenda.py" 2

    debug_msg "Downloading hook: on-modify_agenda.py" 2
    curl -fsSL "$BASE_URL/on-modify_agenda.py" -o "$HOOKS_DIR/on-modify_agenda.py" || {
        tw_error "Failed to download on-modify_agenda.py"
        debug_msg "Download failed: on-modify_agenda.py" 1
        return 1
    }
    chmod +x "$HOOKS_DIR/on-modify_agenda.py"
    debug_msg "Installed hook: $HOOKS_DIR/on-modify_agenda.py" 2

    debug_msg "Downloading config: agenda.rc" 2
    curl -fsSL "$BASE_URL/agenda.rc" -o "$CONFIG_DIR/agenda.rc" || {
        tw_error "Failed to download agenda.rc"
        debug_msg "Download failed: agenda.rc" 1
        return 1
    }
    debug_msg "Installed config: $CONFIG_DIR/agenda.rc" 2

    # Add config to .taskrc
    tw_msg "Adding configuration to .taskrc..."
    local config_line="include $CONFIG_DIR/agenda.rc"

    if ! grep -qF "$config_line" "$TASKRC" 2>/dev/null; then
        echo "$config_line" >> "$TASKRC"
        tw_msg "Added config include to .taskrc"
        debug_msg "Added to .taskrc: $config_line" 2
    else
        tw_msg "Config already in .taskrc"
        debug_msg "Config already present in .taskrc" 2
    fi

    tw_msg "Downloading documentation..."
    curl -fsSL "$BASE_URL/README.md" -o "$DOCS_DIR/agenda-edate_README.md" 2>/dev/null || true
    debug_msg "Downloaded doc: $DOCS_DIR/agenda-edate_README.md" 2

    # Track in manifest
    debug_msg "Writing to manifest" 2
    MANIFEST_FILE="${HOME}/.task/config/.tw_manifest"
    TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    mkdir -p "$(dirname "$MANIFEST_FILE")"

    echo "$APPNAME|$VERSION|$HOOKS_DIR/on-add_agenda.py||$TIMESTAMP" >> "$MANIFEST_FILE"
    debug_msg "Manifest entry: $HOOKS_DIR/on-add_agenda.py" 3
    echo "$APPNAME|$VERSION|$HOOKS_DIR/on-modify_agenda.py||$TIMESTAMP" >> "$MANIFEST_FILE"
    debug_msg "Manifest entry: $HOOKS_DIR/on-modify_agenda.py" 3
    echo "$APPNAME|$VERSION|$CONFIG_DIR/agenda.rc||$TIMESTAMP" >> "$MANIFEST_FILE"
    debug_msg "Manifest entry: $CONFIG_DIR/agenda.rc" 3
    echo "$APPNAME|$VERSION|$DOCS_DIR/agenda-edate_README.md||$TIMESTAMP" >> "$MANIFEST_FILE"
    debug_msg "Manifest entry: $DOCS_DIR/agenda-edate_README.md" 3

    debug_msg "Installation complete" 1
    tw_success "Installed agenda-edate v$VERSION"
    echo ""
    tw_msg "Documentation: $DOCS_DIR/agenda-edate_README.md"
    echo ""

    return 0
}

# ============================================================================
# Removal Function
# ============================================================================

remove() {
    tw_msg "Removing agenda-edate..."
    debug_msg "Starting removal" 1

    MANIFEST_FILE="${HOME}/.task/config/.tw_manifest"
    if [ ! -f "$MANIFEST_FILE" ]; then
        tw_error "Manifest file not found"
        return 1
    fi

    # Remove files based on manifest
    grep "^$APPNAME|" "$MANIFEST_FILE" | cut -d"|" -f3 | while read -r file; do
        if [ -f "$file" ]; then
            rm "$file"
            debug_msg "Removed: $file" 2
            tw_msg "Removed: $(basename $file)"
        fi
    done

    # Remove from manifest
    sed -i.bak "/^$APPNAME|/d" "$MANIFEST_FILE"
    debug_msg "Removed from manifest" 2

    # Remove config from .taskrc
    local config_line="include $CONFIG_DIR/agenda.rc"
    if grep -qF "$config_line" "$TASKRC" 2>/dev/null; then
        sed -i.bak "\|$config_line|d" "$TASKRC"
        tw_msg "Removed config from .taskrc"
        debug_msg "Removed from .taskrc: $config_line" 2
    fi

    tw_success "Removed agenda-edate"
    return 0
}

# ============================================================================
# Main
# ============================================================================

case "${1:-install}" in
    install)
        install
        ;;
    remove|uninstall)
        remove
        ;;
    *)
        echo "Usage: $0 {install|remove}"
        exit 1
        ;;
esac
